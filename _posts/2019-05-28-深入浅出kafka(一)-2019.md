---
layout:     post
title:      "深入浅出kafka(一)"
subtitle:   "kafka内部结构介绍"
date:       2019-05-28 21:06:00
author:     "Tommy"
header-img: "img/post-bg-java.jpg"
catalog: true
tags:
    - kafka
    - bigdata
---

## kafka的几个重要概念

- `Broker`：消息中间件处理结点，一个Kafka节点就是一个broker，多个broker可以组成一个Kafka集群；
- `Topic`：一类消息，例如note impression日志、click日志等都可以以topic的形式存在，Kafka集群能够同时负责多个topic的分发；
- `Partition`：topic物理上的分组，一个topic可以分为多个partition，每个partition是一个有序的队；
- `segment`：每个partition又由多个segment file组成；
- `offset`：每个partition都由一系列有序的、不可变的消息组成，这些消息被连续的追加到partition中。partition中的每个消息都有一个连续的序列号叫做offset，用于partition唯一标识一条消息；
- `message`：这个算是kafka文件中最小的存储单位，即是 one commit log。

kafka的message是以topic为基本单位，不同topic之间是相互独立的。
每个topic又可分为几个不同的partition，每个partition存储一部分message。
同一个topic的不同partition可以分布在不同的broker上，这正是分布式的设计。
partition是以文件夹的形式存储在broker机器上。
topic与partition的关系如下：
<img src = "/img/bigdata/kafka/topic.png">

## Partition中的文件
### segment file
对于一个partition，里面又有很多大小相等的segment数据文件（这个文件的具体大小可以在config/server.properties中进行设置），这种特性可以方便old segment file的快速删除。

下面介绍一下partition中的segment file的组成：
1. segment file 组成：由2部分组成，分别为index file和data file，这两个文件是一一对应的，后缀”.index”和”.log”分别表示索引文件和数据文件；
2. 自0.10.0.1开始的kafka segment file组成：多了一部分，还有.timeindex索引文件，基于时间的索引文件；目前支持的时间戳类型有两种： CreateTime 和 LogAppendTime 前者表示producer创建这条消息的时间；后者表示broker接收到这条消息的时间(严格来说，是leader broker将这条消息写入到log的时间)
3. segment file 命名规则：partition的第一个segment从0开始，后续每个segment文件名为上一个segment文件最后一条消息的offset,ofsset的数值最大为64位（long类型），20位数字字符长度，没有数字用0填充。如下图所示：
老版本segment结构:
<img src = "/img/bigdata/kafka/segment.png">
新版本segment结构:
<img src = "/img/bigdata/kafka/new_segment.png">

4. 关于segment file中index索引文件与data文件对应关系图，这里我们借用网上的一个图片，如下所示：
<img src = "/img/bigdata/kafka/index.png">

5. segment的索引文件中存储着大量的元数据，数据文件中存储着大量消息，索引文件中的元数据指向对应数据文件中的message的物理偏移地址。以索引文件中的6，1407为例，在数据文件中表示第6个message（在全局partition表示第368775个message），以及该消息的物理偏移地址为1407。

注：index文件的第一个数，是data数据的相对offset。